<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org">
<title>SerialPort message protocol</title>
</head>
<body>
<h1>SerialPort message protocol</h1>

<p><i>SerialPort</i> uses a command and response protocol. Commands
are issued by the application interface and every command receives
a response from the server. Commands that trigger immediate
actions, such as opening a connection, setting its operating
conditions or querying its state, are carried out when they are
received and the result of the command is returned in the response.
Commands that may take some time to complete generate an immediate
response showing whether the command was accepted while the
associated activity, such as sending a block of data to the remote
host, continues asynchronously until it completes. The server
supports queries that allow the progress of asynchronous activities
to be monitored.</p>

<p>In the interest of maximising throughput there are no wait
states in the server apart from the per-character transmission
delay, a configurable pause to allow a slow remote host to deal
with each character before it is sent the next one.
<i>SerialPort</i> implements functions that calculate and apply a
waiting time to allow for data to be transferred to the remote host
and for it to transmit a block of data in reply. This is
implemented entirely within the interface code, so the application
that has requested the transfers is the only process that is
suspended during the waiting time.</p>

<h2>Message format</h2>

<p>Each message has a common format:</p>

<p><b><kbd>C,nnnn,value</kbd></b></p>

<p>where:</p>

<table summary="Fields">
<tr>
<td valign="top"><b>C</b></td>
<td>is the command code:<br>
<table summary="Mnemonics">
<tr>
<td>C</td>
<td>close port</td>
</tr>

<tr>
<td>D</td>
<td>set transmission delay per character</td>
</tr>

<tr>
<td>G</td>
<td>get input</td>
</tr>

<tr>
<td>I</td>
<td>echo mode</td>
</tr>

<tr>
<td>L</td>
<td>request_portlist</td>
</tr>

<tr>
<td>O</td>
<td>open port</td>
</tr>

<tr>
<td>P</td>
<td>output text</td>
</tr>

<tr>
<td>Q</td>
<td>query buffer state</td>
</tr>

<tr>
<td>R</td>
<td>reset linespec, tx delay, record separator</td>
</tr>

<tr>
<td>S</td>
<td>set port params</td>
</tr>

<tr>
<td>T</td>
<td>set record separator</td>
</tr>
</table>
</td>
</tr>

<tr>
<td valign="top"><b>nnnn</b></td>
<td>is the length of the following value, max 1500 bytes.</td>
</tr>

<tr>
<td valign="top"><b>value</b></td>
<td>is dependent on the command mnemonic.<br>
<table summary="Value meanings">
<tr>
<td><b>Command</b></td>
<td><b>Value in the command</b></td>
<td><b>Value in the response</b></td>
</tr>

<tr>
<td valign="top">C [1]</td>
<td>force</td>
<td>n/a</td>
</tr>

<tr>
<td valign="top">D</td>
<td>delay (in mSec)</td>
<td>n/a</td>
</tr>

<tr>
<td valign="top">G</td>
<td>max bytes to be retrieved</td>
<td>character string</td>
</tr>

<tr>
<td valign="top">L</td>
<td>n/a</td>
<td>port name string (CSV format)</td>
</tr>

<tr>
<td valign="top">O</td>
<td>portname</td>
<td>baud,dbits,par,sbits</td>
</tr>

<tr>
<td valign="top">P</td>
<td>character string</td>
<td>n/a</td>
</tr>

<tr>
<td valign="top">Q [2]</td>
<td>n/a</td>
<td>input,output,buffsize</td>
</tr>

<tr>
<td valign="top">R [3]</td>
<td>linespec|delay|separator</td>
<td>n/a</td>
</tr>

<tr>
<td valign="top">S</td>
<td>baud,dbits,par,sbits</td>
<td>n/a</td>
</tr>

<tr>
<td valign="top">T [4]</td>
<td>active|marker|external</td>
<td>n/a</td>
</tr>
</table>
</td>
</tr>
</table>

<h3>Notes:</h3>

<table summary="numbered notes">
<tr>
<td valign="top">[1]:</td>
<td>The force value is a string. If the first character starts with
<b>T</b>, <b>t</b> or <b>1</b> the port will be forced closed
regardless of whether there is still data in the server's buffers.
Any other value or a zero <i>value length</i> will cause a normal
close if the buffers are empty but will leave the port open and
return an error if there is still data in the buffers.</td>
</tr>

<tr>
<td valign="top">[2]:</td>
<td>The command returns three comma-separated numbers. These are
the number of bytes in the input buffer, the number of bytes in the
output buffer and the buffer size. Both buffers are the same
size.</td>
</tr>

<tr>
<td valign="top">[3]:</td>
<td>These parameters are three fixed length single byte values.
They are concatenated to form a three byte command parameter. All
are boolean and may be T/F, t/f or 1/0. Each controls whether a set
of control variables are reset ot not. 

<ul>
<li><i>linespec</i> resets the baudrate, databits, parity and stop
bits to the default values for the line.</li>

<li><i>delay</i> resets the per-character transmission delay to
zero.</li>

<li><i>separator</i> sets the field separator to <i>inactive</i>,
clears the separator character and marks the separator as
<i>internal</i>.</li>
</ul>
</td>
</tr>

<tr>
<td valign="top">[4]:</td>
<td>These parameters are three fixed length single byte values.
They are concatenated to form a three byte command parameter.
<i>active</i> and <i>external</i> are boolean and may be
<b>T/F</b>, <b>t/f</b> or <b>1/0</b>. <i>marker</i> can be any
ASCII character code. 

<ul>
<li>setting <i>active</i> enables the use of the <i>marker</i>
value as a field separator</li>

<li><i>marker</i> is the field separator character</li>

<li>setting <i>external</i> causes <i>marker</i> to be appended to
each <b>P</b> value string and to be removed from the end of the
<b>G</b> value. If <i>external</i> is unset the field marker, if
any, must be included in the <b>P</b> value string and, though it
delimits the <b>G</b> value, it is returned as the last character
in the value.</li>
</ul>
</td>
</tr>
</table>

<h2>Command/response relationships</h2>

<p>Every command generates a response. The <i>command code</i> in
the response is set according to the following rules:</p>

<ul>
<li>If the response may contain data its <i>command code</i> is the
same as the triggering command.</li>

<li>If the response can never contain data the <i>command code</i>
is <b>A</b>.</li>

<li>If the command caused an error, the <i>command code</i> is
<b>E</b> and the <i>value</i> is the error message.</li>
</ul>

<p>Output is sent to the port with a <b>P</b> command. The response
is returned immediately. The data has been buffered for
transmission but nothing has been transmitted to the remote host
when the response is sent. If external separators are enabled the
<b>P</b> command causes a separator to be appended to the output
byte list.</p>

<p>Input is retrieved with the <b>G</b> command. All immediately
available characters up the the requested maximum are returned. If
no data is available a <b>G</b> response with a zero length
<i>value</i> is returned. If separators are enabled the current
separator character will terminate the retrieval if it is
encountered within the available characters. If the terminator is
<i>external</i> it is not returned as part of the retrieved bytes
list, but if it is <i>internal</i> then the terminator is the last
character in <i>value</i>.</p>
</body>
</html>

