#
# multitest -opts file...
#

if [ $# -ge 1 -a "$1" == '-?' ]
then
	echo "multitest [-opts] file..."
	echo The opts, if present, are spd options
	exit 1
fi

#
# Find the options, if any
#
for arg
do
	r=$(expr $arg : '-d*' '>' 1)
	if [ "$r" == 1 ]
	then
		opts=${opts}" "$arg
		shift
	fi
done

#
# Start the server
#
if [ "$opts" == '' ]
then
	spd &
else
	spd $opts 2>spd.log &
fi
sleep 1

#
# Function to launch one client
#
function run_client {
	fout="multi_"`basename $1`;
	echo "$1 script output sent to $fout";
	testspd $1 >$fout &
}

#
# Start the clients after clearing out pseudo-serial files
#
rm -f port[1-9].txt multi_*
for file
do
	run_client $file
done

#
# wait for all jobs to end
#
state="run"
while [ $state == "run" ]
do
	list=`ps | grep testspd`
	echo "Jobs=$list"
	if [ "$list" == '' ]
	then
		state="stop"
	fi
	echo "state=$state  list=$list"
	sleep 5
done

echo "Stopping now"
spc status stop
exit
